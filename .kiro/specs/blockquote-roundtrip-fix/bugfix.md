# Bugfix Requirements Document

## Introduction

Blockquotes and GitHub-style alerts (NOTE, WARNING, IMPORTANT, TIP, CAUTION) lose fidelity during md→docx→md roundtrip conversion. Converting `test/fixtures/blockquotes.md` to `.docx` and back produces a markdown file that differs from the original, and re-converting that file to `.docx` confirms the differences have real visual/structural impact. The issues affect both the md→docx direction (how blockquotes are encoded into docx XML) and the docx→md direction (how blockquote paragraphs are reconstructed into markdown). A critical requirement is lossless roundtrip fidelity for inter-blockquote whitespace: the exact number and placement of blank lines between blockquote groups must be preserved byte-for-byte, because even semantically meaningless whitespace differences create noisy diffs in git version control.

## Bug Analysis

### Current Behavior (Defect)

1.1 WHEN a markdown file containing consecutive GitHub-style alerts separated by one or more blank lines is converted md→docx→md THEN the system produces markdown where the exact count and placement of inter-block blank lines is not preserved (e.g., two blank lines between alerts may become one, or zero), because the docx format does not encode the blank-line separators between distinct blockquote/alert groups and the docx→md converter has no signal to re-insert them at the correct count.

1.2 WHEN a markdown file containing GitHub-style alerts is converted md→docx→md THEN the system may emit duplicate or residual alert glyph/title prefixes (e.g., "※ Note") in the roundtripped markdown text, because the `stripAlertLeadPrefix` heuristic in `converter.ts` does not always match the exact prefix format that `md-to-docx.ts` generates.

1.3 WHEN a markdown file containing simple (non-alert) blockquotes interspersed with alert blockquotes is converted md→docx→md THEN the system may fail to distinguish between the end of one blockquote group and the start of the next, causing consecutive blockquotes of different types to merge into a single block, and any blank lines that originally separated them are lost.

1.4 WHEN spacer paragraphs (exact-height empty paragraphs with inline left border, generated by `generateParagraph` for `alertFirst`/`alertLast`) are encountered during docx→md conversion THEN the system treats them as plain paragraphs (they have no `pStyle`), potentially injecting extra blank lines or disrupting blockquote continuity in the output markdown.

1.5 WHEN a markdown file has no blank lines between two consecutive blockquote groups (i.e., the `>` lines are directly adjacent with no intervening blank line) and is converted md→docx→md THEN the system may incorrectly insert blank lines that were not present in the original, or merge the two groups into one.

1.6 WHEN a markdown file has asymmetric blank-line separation around a blockquote group (e.g., a blank line above but not below, or below but not above) and is converted md→docx→md THEN the system does not preserve this asymmetry, producing output with different whitespace than the original.

1.7 WHEN a markdown file has multiple consecutive blank lines (e.g., two or three blank lines) between blockquote groups and is converted md→docx→md THEN the system collapses or alters the count of blank lines, even though the exact count is significant for git version control fidelity.

### Expected Behavior (Correct)

2.1 WHEN a markdown file containing consecutive GitHub-style alerts separated by blank lines is converted md→docx→md THEN the system SHALL produce markdown where the exact number of blank lines between each pair of alert blocks is identical to the original source, preserving the precise inter-block whitespace byte-for-byte.

2.2 WHEN a markdown file containing GitHub-style alerts is converted md→docx→md THEN the system SHALL emit clean alert markers (`[!NOTE]`, `[!WARNING]`, etc.) without residual glyph/title prefixes leaking into the body text.

2.3 WHEN a markdown file containing simple blockquotes interspersed with alert blockquotes is converted md→docx→md THEN the system SHALL correctly separate each blockquote group by type, preserving the distinction between plain blockquotes and alert blockquotes, and preserving the exact number of blank lines between each group as in the original.

2.4 WHEN spacer paragraphs (alertFirst/alertLast decorative paragraphs) are encountered during docx→md conversion THEN the system SHALL silently skip them without emitting extra blank lines or disrupting blockquote structure.

2.5 WHEN a markdown file has no blank lines between two consecutive blockquote groups and is converted md→docx→md THEN the system SHALL produce output with no blank lines between those groups, exactly matching the original.

2.6 WHEN a markdown file has asymmetric blank-line separation around a blockquote group (e.g., one blank line above but none below, or vice versa) and is converted md→docx→md THEN the system SHALL preserve the exact asymmetric blank-line pattern from the original.

2.7 WHEN a markdown file has multiple consecutive blank lines (two, three, or more) between blockquote groups and is converted md→docx→md THEN the system SHALL preserve the exact count of consecutive blank lines from the original, even if those extra blank lines have no semantic meaning in markdown.

### Unchanged Behavior (Regression Prevention)

3.1 WHEN a markdown file containing a single simple blockquote (no alerts) is converted md→docx→md THEN the system SHALL CONTINUE TO produce an identical blockquote in the output.

3.2 WHEN a markdown file containing a single GitHub-style alert is converted md→docx→md THEN the system SHALL CONTINUE TO produce the same alert with correct `[!TYPE]` marker and body text.

3.3 WHEN a markdown file containing headings, paragraphs, lists, and other non-blockquote content is converted md→docx→md THEN the system SHALL CONTINUE TO preserve those elements without any change in behavior.

3.4 WHEN blockquotes are nested (blockquote within a blockquote) THEN the system SHALL CONTINUE TO preserve the nesting level during roundtrip conversion.

3.5 WHEN a markdown file containing code blocks, tables, or footnotes adjacent to blockquotes is converted md→docx→md THEN the system SHALL CONTINUE TO preserve the correct separation and formatting of all elements.

3.6 WHEN blank lines exist within a single blockquote group (e.g., between paragraphs inside the same `>` block) THEN the system SHALL CONTINUE TO preserve those intra-block blank lines during roundtrip conversion.
