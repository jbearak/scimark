# Design Document: Zotero Citation Roundtrip

## Overview

This feature extends the existing DOCX-to-Markdown converter to extract Zotero-specific identifiers (item keys and URIs) from Word field codes and store them in BibTeX custom fields. The changes are minimal: extend the existing extraction and generation functions in `src/converter.ts` to capture and emit two additional fields per citation item.

The BibTeX file serves as the single source of truth for all Zotero metadata, avoiding a separate metadata file that could fall out of sync if the user edits one file but not the other.

## Background: Zotero Field Code Structure

Zotero stores citations in `word/document.xml` as complex field codes:

```xml
<w:r><w:fldChar w:fldCharType="begin"/></w:r>
<w:r><w:instrText xml:space="preserve"> ADDIN ZOTERO_ITEM CSL_CITATION {...}</w:instrText></w:r>
<w:r><w:fldChar w:fldCharType="separate"/></w:r>
<w:r><w:t>(Author 2020)</w:t></w:r>
<w:r><w:fldChar w:fldCharType="end"/></w:r>
```

The JSON payload contains:

```json
{
  "citationID": "a2882e2be5k",
  "properties": { "plainCitation": "(Allen 2011, 188)" },
  "citationItems": [
    {
      "id": 342,
      "uris": ["http://zotero.org/users/local/ibWt60LF/items/P5EYVHT4"],
      "itemData": { "type": "book", "title": "...", "author": [...], ... },
      "locator": "188"
    }
  ]
}
```

Key facts:
- The 8-character item key (e.g., `P5EYVHT4`) at the end of the URI is the stable identifier linking to the Zotero library
- URI formats vary by library type but all end with `/items/{KEY}`: local (`users/local/{id}/items/{KEY}`), synced (`users/{id}/items/{KEY}`), group (`groups/{id}/items/{KEY}`)
- `citationID` and numeric `id` are document-local and regenerated by Zotero — not needed for roundtrip
- Locators are plain strings (e.g., `"20"`) without prefix; Zotero handles formatting during rendering
- Multiple items in one `citationItems` array represent a grouped citation like `(Smith 2020; Jones 2021)`

## Architecture

No new modules. Changes are confined to `src/converter.ts`:

```
extractZoteroCitations()
  └─ NEW: parse uris/uri, extract item key, capture locator
       │
       ▼
  CitationMetadata (extended with zoteroKey, zoteroUri, locator)
       │
       ▼
generateBibTeX()
  └─ NEW: emit zotero-key and zotero-uri fields

extractDocumentContent() / buildMarkdown()
  └─ NEW: emit locator in Pandoc citation syntax
```

## Components and Interfaces

### 1. Extended `CitationMetadata` Interface

```typescript
export interface CitationMetadata {
  // ... existing fields (authors, title, year, journal, volume, pages, doi, type, fullItemData)
  zoteroKey?: string;   // 8-char item key extracted from URI
  zoteroUri?: string;   // Full Zotero URI
  locator?: string;     // Page/section reference (plain string)
}
```

### 2. URI Parsing

Extract item key from the end of any Zotero URI format:

```typescript
const ZOTERO_KEY_RE = /\/items\/([A-Z0-9]{8})$/;
```

Applied to the first entry in `uris` or `uri` array of each citation item.

### 3. Extended BibTeX Output

```bibtex
@article{bearak2020,
  author = {Bearak, Jonathan},
  title = {{Unintended pregnancy}},
  year = {2020},
  doi = {10.1016/S2214-109X(20)30315-6},
  zotero-key = {P5EYVHT4},
  zotero-uri = {http://zotero.org/users/local/ibWt60LF/items/P5EYVHT4},
}
```

### 4. Markdown Citation with Locator

Pandoc citation syntax:
- Without locator: `[@bearak2020]`
- With locator: `[@bearak2020, p. 20]`
- Grouped with mixed locators: `[@smith2020, p. 42; @jones2021]`

## Design Decisions

1. **No separate metadata file**: All Zotero identifiers live in BibTeX custom fields. This avoids sync conflicts if the user edits `.bib` but not a hypothetical `.json` file (or vice versa).

2. **Citation grouping via markdown syntax**: Multiple items from one Zotero field code are emitted as `[@key1; @key2]`. The markdown syntax itself preserves the grouping — no additional BibTeX metadata needed.

3. **Locators in markdown, not BibTeX**: Locators are a property of a citation instance (how a work was cited in a specific spot), not a property of the bibliographic entry. They belong in the markdown citation, not the bib file.

4. **Ignore citationID and numeric id**: These are document-local values regenerated by Zotero when field codes are created. Only item keys are needed for roundtrip.

## Edge Cases

- **Missing URI**: Citation item has no `uris`/`uri` field → omit `zotero-key` and `zotero-uri` from BibTeX; citation still works via existing metadata
- **Malformed URI**: URI doesn't match expected pattern → omit `zotero-key`; still store `zotero-uri` for debugging
- **Duplicate items**: Same item cited multiple times → `generateBibTeX()` already deduplicates via `emitted` set; `zotero-key` is consistent across occurrences
- **Empty locator string**: Treat as no locator
