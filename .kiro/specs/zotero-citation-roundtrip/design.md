# Design Document: Zotero Citation Roundtrip

## Overview

This feature extends the existing DOCX-to-Markdown converter to extract Zotero-specific identifiers (item keys and URIs) from Word field codes and store them in BibTeX custom fields. The changes are minimal: extend the existing extraction and generation functions in `src/converter.ts` to capture and emit two additional fields per citation item.

The BibTeX file serves as the single source of truth for all Zotero metadata, avoiding a separate metadata file that could fall out of sync if the user edits one file but not the other.

## Background: Zotero Field Code Structure

Zotero stores citations in `word/document.xml` as complex field codes:

```xml
<w:r><w:fldChar w:fldCharType="begin"/></w:r>
<w:r><w:instrText xml:space="preserve"> ADDIN ZOTERO_ITEM CSL_CITATION {...}</w:instrText></w:r>
<w:r><w:fldChar w:fldCharType="separate"/></w:r>
<w:r><w:t>(Author 2020)</w:t></w:r>
<w:r><w:fldChar w:fldCharType="end"/></w:r>
```

The JSON payload contains:

```json
{
  "citationID": "a2882e2be5k",
  "properties": { "plainCitation": "(Allen 2011, 188)" },
  "citationItems": [
    {
      "id": 342,
      "uris": ["http://zotero.org/users/local/ibWt60LF/items/P5EYVHT4"],
      "itemData": { "type": "book", "title": "...", "author": [...], ... },
      "locator": "188"
    }
  ]
}
```

Key facts:
- The 8-character item key (e.g., `P5EYVHT4`) at the end of the URI is the stable identifier linking to the Zotero library
- URI formats vary by library type but all end with `/items/{KEY}`: local (`users/local/{id}/items/{KEY}`), synced (`users/{id}/items/{KEY}`), group (`groups/{id}/items/{KEY}`)
- `citationID` and numeric `id` are document-local and regenerated by Zotero — not needed for roundtrip
- Locators are plain strings (e.g., `"20"`) without prefix; Zotero handles formatting during rendering
- Multiple items in one `citationItems` array represent a grouped citation like `(Smith 2020; Jones 2021)`

## Architecture

No new modules. Changes are confined to `src/converter.ts`:

```
extractZoteroCitations()
  └─ NEW: parse uris/uri, extract item key, capture locator
       │
       ▼
  CitationMetadata (extended with zoteroKey, zoteroUri, locator)
       │
       ▼
generateBibTeX()
  └─ NEW: emit zotero-key and zotero-uri fields

extractDocumentContent() / buildMarkdown()
  └─ NEW: emit locator in Pandoc citation syntax
```

## Components and Interfaces

### 1. Extended `CitationMetadata` Interface

```typescript
export interface CitationMetadata {
  // ... existing fields (authors, title, year, journal, volume, pages, doi, type, fullItemData)
  zoteroKey?: string;   // 8-char item key extracted from URI
  zoteroUri?: string;   // Full Zotero URI
  locator?: string;     // Page/section reference (plain string)
}
```

### 2. URI Parsing

Extract item key from the end of any Zotero URI format:

```typescript
const ZOTERO_KEY_RE = /\/items\/([A-Z0-9]{8})$/;
```

Applied to the first entry in `uris` or `uri` array of each citation item.

### 3. Extended BibTeX Output

```bibtex
@article{bearak2020,
  author = {Bearak, Jonathan},
  title = {{Unintended pregnancy}},
  year = {2020},
  doi = {10.1016/S2214-109X(20)30315-6},
  zotero-key = {P5EYVHT4},
  zotero-uri = {http://zotero.org/users/local/ibWt60LF/items/P5EYVHT4},
}
```

### 4. Markdown Citation with Locator

Pandoc citation syntax:
- Without locator: `[@bearak2020]`
- With locator: `[@bearak2020, p. 20]`
- Grouped with mixed locators: `[@smith2020, p. 42; @jones2021]`

## Design Decisions

1. **No separate metadata file**: All Zotero identifiers live in BibTeX custom fields. This avoids sync conflicts if the user edits `.bib` but not a hypothetical `.json` file (or vice versa).

2. **Citation grouping via markdown syntax**: Multiple items from one Zotero field code are emitted as `[@key1; @key2]`. The markdown syntax itself preserves the grouping — no additional BibTeX metadata needed.

3. **Locators in markdown, not BibTeX**: Locators are a property of a citation instance (how a work was cited in a specific spot), not a property of the bibliographic entry. They belong in the markdown citation, not the bib file.

4. **Ignore citationID and numeric id**: These are document-local values regenerated by Zotero when field codes are created. Only item keys are needed for roundtrip.

## Edge Cases

- **Missing URI**: Citation item has no `uris`/`uri` field → omit `zotero-key` and `zotero-uri` from BibTeX; citation still works via existing metadata
- **Malformed URI**: URI doesn't match expected pattern → omit `zotero-key`; still store `zotero-uri` for debugging
- **Duplicate items**: Same item cited multiple times → `generateBibTeX()` already deduplicates via `emitted` set; `zotero-key` is consistent across occurrences
- **Empty locator string**: Treat as no locator

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system — essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

The following properties target the pure functions in `src/converter.ts` that can be tested without constructing DOCX zip files: URI key extraction (regex), `generateBibTeX()`, `citationPandocKeys()`, and `escapeBibtex()`.

### Property 1: URI key extraction across all formats

*For any* 8-character alphanumeric key and any Zotero URI format (local, synced, or group), applying the regex `/\/items\/([A-Z0-9]{8})$/` to the URI SHALL extract exactly that key.

Generators produce URIs in all three formats:
- `http://zotero.org/users/local/{localID}/items/{KEY}`
- `http://zotero.org/users/{numericID}/items/{KEY}`
- `http://zotero.org/groups/{numericID}/items/{KEY}`

**Validates: Requirements 1.2, 1.3, 1.4, 1.5**

### Property 2: BibTeX zotero fields biconditional

*For any* `CitationMetadata`, the output of `generateBibTeX()` contains a `zotero-key` field if and only if `CitationMetadata.zoteroKey` is set, and contains a `zotero-uri` field if and only if `CitationMetadata.zoteroUri` is set. When present, the field values match the input exactly.

**Validates: Requirements 1.6, 2.1, 2.2, 2.3**

### Property 3: Locator formatting in Pandoc keys

*For any* `ZoteroCitation` with items that have keys in the key map, `citationPandocKeys()` returns a key ending with `, p. <locator>` if and only if that item's `locator` field is a non-empty string. Items without a locator produce a bare key with no suffix.

**Validates: Requirements 3.1, 3.2**

### Property 4: Citation grouping preserves all items

*For any* `ZoteroCitation` containing N items (all with entries in the key map), `citationPandocKeys()` returns exactly N strings — one per item, in order.

**Validates: Requirements 4.1, 4.2**

### Property 5: BibTeX special character escaping

*For any* input string, the output of `escapeBibtex()` contains no unescaped occurrences of the BibTeX special characters `& % $ # _ { } ~ ^ \`. Every special character in the output is preceded by a backslash.

**Validates: Requirements 2.4**

## Error Handling

Error handling is unchanged from the existing converter design:

- **Malformed JSON in field codes**: `extractZoteroCitations()` catches parse errors and pushes a placeholder `{ plainCitation: '', items: [] }` to keep positional indices aligned.
- **Missing URI fields**: Gracefully omitted — `zoteroKey` and `zoteroUri` remain `undefined`, and `generateBibTeX()` skips those fields.
- **Empty/whitespace locator**: Treated as absent — the `if (item.locator && ... item.locator.trim())` guard filters these out.

## Testing Strategy

### Dual approach

- **Unit tests** (existing, all passing): Cover specific examples — known URI formats, known BibTeX output shapes, known locator formatting. These are already implemented in `src/converter.test.ts`.
- **Property-based tests** (new): Cover universal properties across randomly generated inputs using `fast-check` (v4.3.0, already a devDependency). These validate that the pure functions behave correctly for *all* valid inputs, not just hand-picked examples.

### Property-based testing configuration

- Library: `fast-check` (already installed)
- Runner: `bun test`
- Minimum iterations: 100 per property
- Each test tagged with: **Feature: zotero-citation-roundtrip, Property {N}: {title}**
- Use bounded generators to avoid timeouts on large strings (per AGENTS.md learning)
- `escapeBibtex` is exported from `converter.ts`

### Test file

Property tests go in a new file `src/converter.property.test.ts`, separate from the existing unit tests in `src/converter.test.ts`.
