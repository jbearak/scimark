# Zotero Citation Roundtrip Support

**Goal**: Enable bidirectional conversion (docx→md→docx) while preserving Zotero citation metadata, allowing users to edit and update citations in the reconstituted Word document.

## Research Summary

### Zotero Field Code Structure

Zotero stores citations in Word documents using `ADDIN` field codes with the following structure:

```text
{ ADDIN ZOTERO_ITEM CSL_CITATION <JSON_DATA> }
```

The JSON data contains:
- `citationID`: Unique identifier for this citation instance (regenerated by Zotero; not needed for roundtrip)
- `properties`: Formatted citation text and metadata
- `citationItems`: Array of cited items, each containing:
  - `id`: Numeric ID within the document (document-local; not needed for roundtrip)
  - `uris` / `uri`: Array of Zotero item URIs (e.g., `http://zotero.org/users/local/ibWt60LF/items/P5EYVHT4`)
  - `itemData`: Full CSL-JSON metadata (authors, title, year, journal, abstract, etc.)
  - `locator`: Optional page/section reference (plain string, e.g., `"20"`)

**Key identifier**: The 8-character alphanumeric item key (e.g., `P5EYVHT4`) in the URI is the stable identifier that links to the Zotero library entry.

### Bibliography Field Code

Zotero also inserts a bibliography field:
```text
{ ADDIN ZOTERO_BIBL <JSON_DATA> }
```

This contains document-level citation style and preferences.

### DOCX XML Structure

Field codes are stored in `word/document.xml` as complex fields:
```xml
<w:r>
  <w:fldChar w:fldCharType="begin"/>
</w:r>
<w:r>
  <w:instrText xml:space="preserve"> ADDIN ZOTERO_ITEM {...}</w:instrText>
</w:r>
<w:r>
  <w:fldChar w:fldCharType="separate"/>
</w:r>
<w:r>
  <w:t>(Author 2020)</w:t>
</w:r>
<w:r>
  <w:fldChar w:fldCharType="end"/>
</w:r>
```

## Requirements

### R1: Extract Zotero Identifiers
- Parse `ZOTERO_ITEM` field codes from `word/document.xml`
- Extract item URIs from each `citationItems` entry
- Parse 8-character item keys from URIs using regex: `/\/items\/([A-Z0-9]{8})$/`
- URI formats vary by library type but all end with `/items/{ITEMKEY}`:
  - Local: `http://zotero.org/users/local/{localID}/items/{KEY}`
  - Synced: `http://zotero.org/users/{userID}/items/{KEY}`
  - Group: `http://zotero.org/groups/{groupID}/items/{KEY}`

### R2: Preserve Identifiers in BibTeX
- Add custom BibTeX field `zotero-key` containing the 8-character item key
- Add custom field `zotero-uri` containing the full URI
- BibTeX parsers ignore unknown fields, so these are safe to add

### R3: Markdown Citation Format
- Keep existing `[@citationKey]` format for inline citations
- Locators (page/section references) are stored in the markdown citation using Pandoc syntax: `[@citationKey, p. 20]`
  - Zotero stores locators as plain strings (e.g., `"20"`) without prefix; we add the `p.` prefix in markdown output
- Multiple citations: `[@key1; @key2]` — markdown syntax preserves grouping for reconstruction into a single Zotero field code

## Design

### Data Flow

```text
DOCX → Extract → Markdown + BibTeX
                     ↓
                  (Edit)
                     ↓
Markdown + BibTeX → Reconstruct → DOCX
```

### File Outputs

1. **`{base}.md`**: Markdown with `[@citationKey]` citations (locators inline)
2. **`{base}.bib`**: BibTeX with `zotero-key` and `zotero-uri` fields (single source of truth)

### Extended BibTeX Format

```bibtex
@article{bearak2020,
  author = {Bearak, Jonathan and Popinchalk, Anna and Ganatra, Bela},
  title = {{Unintended pregnancy and abortion by income, region, and the legal status of abortion}},
  journal = {The Lancet Global Health},
  volume = {8},
  pages = {e1152--e1161},
  year = {2020},
  doi = {10.1016/S2214-109X(20)30315-6},
  zotero-key = {P5EYVHT4},
  zotero-uri = {http://zotero.org/users/local/ibWt60LF/items/P5EYVHT4},
}
```

## Implementation Tasks

### Phase 1: Extraction (docx→md)

1. **Extend `extractZoteroCitations()`**
   - Parse `uris` / `uri` field from each citation item
   - Extract 8-character item key from URI using regex: `/\/items\/([A-Z0-9]{8})$/`
   - Capture `locator` if present

2. **Extend `CitationMetadata` interface**
   ```typescript
   interface CitationMetadata {
     // ... existing fields
     zoteroKey?: string;        // 8-char item key
     zoteroUri?: string;        // Full URI
     locator?: string;          // Page/section reference (plain string)
   }
   ```

3. **Update `generateBibTeX()`**
   - Add `zotero-key` field if `meta.zoteroKey` exists
   - Add `zotero-uri` field if `meta.zoteroUri` exists

4. **Update markdown citation output**
   - Emit `[@key, p. 20]` when locator is present

### Phase 2: Reconstruction (md→docx) — Future Work

This phase is out of scope for the current spec but requires:
- Parse BibTeX `zotero-key` and `zotero-uri` fields
- Map `[@citationKey]` back to Zotero item keys via BibTeX lookup
- Parse locators from Pandoc citation syntax
- Reconstruct `ZOTERO_ITEM` field codes with CSL-JSON from BibTeX metadata
- Reconstruct `ZOTERO_BIBL` field code
- Generate DOCX with proper field code XML structure

## Testing

### Unit Tests

1. **URI parsing**
   - Extract item key from local, synced, and group library URIs
   - Reject malformed URIs (missing key, wrong length)

2. **BibTeX generation**
   - Verify `zotero-key` and `zotero-uri` fields are emitted
   - Verify fields are omitted when data is missing
   - Verify escaping doesn't break custom fields

3. **Locator handling**
   - Verify locator appears in markdown citation as `[@key, p. 20]`
   - Verify citations without locators render as `[@key]`

### Integration Tests

1. **Sample DOCX with Zotero citations**
   - Convert to markdown + bibtex
   - Verify all item keys are extracted
   - Verify locators are captured

2. **Edge cases**
   - Multiple citations in one field code
   - Citations without URIs (malformed field codes)
   - Missing bibliography field
   - Empty citation items

## Resolved Design Decisions

1. **URI format variations**: Use regex `/\/items\/([A-Z0-9]{8})$/` to extract item key from end of URI regardless of prefix (handles local, synced user, and group libraries).

2. **Citation ID stability**: Not needed for roundtrip. Zotero generates new citation IDs when field codes are created. We only need item keys.

3. **Locator format**: Stored by Zotero as plain strings (e.g., `"20"`) without prefixes. Locators are a property of a citation instance, not the bibliographic entry, so they belong in the markdown citation (`[@key, p. 20]`) rather than in BibTeX.

4. **Multiple items per citation**: Markdown syntax `[@key1; @key2]` preserves grouping. No additional metadata needed in BibTeX.

5. **Metadata storage**: Store all Zotero identifiers in BibTeX custom fields (`zotero-key`, `zotero-uri`). No separate metadata file — single source of truth avoids sync conflicts if the user edits one file but not the other.

## References

Content was rephrased for compliance with licensing restrictions.

- [Zotero Forums: Field Code Structure](https://forums.zotero.org/discussion/89432/why-field-code-in-ms-word-contain-so-much-informations)
- [Zotero Forums: URI Interpretation](https://forums.zotero.org/discussion/8117/interpretation-of-zotero-embedded-uris-in-openoffice-doc)
- [Office Open XML: Field Codes](http://officeopenxml.com/WPfields.php)
- [Zotero Documentation: Word Field Codes](https://www.zotero.org/support/kb/word_field_codes)
